<!doctype html>
<html>
  <head>
    <title>C'est DéDé</title>
    <link rel="stylesheet" href="/statics/css/vendor/xterm.css" />
    <link rel="stylesheet" href="/statics/css/vendor/fullscreen.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js" integrity="sha256-tSRROoGfGWTveRpDHFiWVz+UXt+xKNe90wwGn25lpw8=" crossorigin="anonymous"></script>

    <script src="/statics/js/vendor/xterm.js"></script>
    <script src="/statics/js/vendor/fit.js"></script>
    <script src="/statics/js/vendor/attach.js"></script>
    <script src="/statics/js/vendor/fullscreen.js"></script>

    <style>
    #dede-terminal {
        width: {{ .Width }}px;
        height: {{ .Height }}px;
        margin: 5px 5px;
        padding: 2px;
    }
    </style>
  </head>
  <body>
    <div id="dede-terminal"></div>
    <script>
      _DedeTerminal = function(id, cols, rows, delay) {
        this.cols = cols || 200;
        this.rows = rows || 40;
        this.delay = delay || 100;

        var container = document.getElementById('dede-terminal');
        var term = term = new Terminal({
          geometry: [this.cols, this.rows],
          //debug: true
        });
        term.open(container);
        term.fit();

        this.term = term;

        var websocket;
        function wsConnect() {
          websocket = new WebSocket("ws://" + location.host + "/terminal/" + id + "/ws");
          websocket.onopen = function(evt) {
            term.attach(websocket);
          };
          websocket.onclose = wsDisconnected;
          websocket.onerror = wsOnError;
        }
        wsConnect();

        function wsOnError() {
          $.notify("Writing error", "error");
        }

        function wsDisconnected(evt) {
          $.notify("Connection error", "error");

          setTimeout(wsConnect, 5000);
        }
      };

      _DedeTerminal.prototype.type = function(str) {
        var self = this;

        var el = str.split('');
        var i = 0;

        var fnc = function() {
          self.term.send(el[i]);
          if (++i < el.length) {
            setTimeout(fnc, self.delay);
          }
        }
        fnc();
      };

      DedeTerminal = new _DedeTerminal("{{ .ID }}", {{ .Cols }}, {{ .Rows }}, {{ .Delay }});
    </script>
  </body>
</html>
